#!/bin/bash
echo "Användarhanteringsverktyg. Endast för root."

# === Kontrollera att exakt ett argument skickats med ===
if [ "$#" -ne 1 ]; then
    echo "Fel: Du måste ange exakt en argument – sökvägen till CSV-filen." >&2
    exit 1
fi

# === Kontrollera att filen finns och är en vanlig fil ===
if [ ! -f "$1" ]; then
    echo "Fel: Filen '$1' finns inte eller är inte en vanlig fil." >&2
    exit 1
fi

# === Skapa eller rensa loggfil ===
LOGFILE="loggfil.txt"
> "$LOGFILE"

# === Läs varje rad i CSV-filen ===
while IFS=',' read -r first last password operation; do

    # === Kontrollera att alla 4 fält är ifyllda ===
    if [ -z "$first" ] || [ -z "$last" ] || [ -z "$password" ] || [ -z "$operation" ]; then
        continue
    fi

    # === Skapa användarnamn: 3 första i förnamn + efternamn, små bokstäver ===
    username="${first:0:3}${last}"
    username="${username,,}"

    # === Om operationen är "add": skapa användare och sätt lösenord ===
    if [ "$operation" = "add" ]; then
        if adduser --disabled-password --gecos "" "$username" >/dev/null 2>&1; then
            echo "Add $username"
            echo "Add $username" >> "$LOGFILE"

            # === Försök sätta lösenord från CSV ===
            if echo "$username:$password" | chpasswd 2>/dev/null; then
                echo "Setting password for $username"
                echo "Setting password for $username" >> "$LOGFILE"
            else
                echo "Fel: Kunde inte sätta lösenord för $username" >&2
            fi
        else
            echo "Fel: Kunde inte skapa användaren $username" >&2
        fi

    # === Om operationen är "remove": ta bort användare och hemkatalog ===
    elif [ "$operation" = "remove" ]; then
        if deluser --remove-home "$username" >/dev/null 2>&1; then
            echo "Remove $username"
            echo "Remove $username" >> "$LOGFILE"
        else
            echo "Fel: Kunde inte ta bort användaren $username" >&2
        fi
    fi

done < "$1"

